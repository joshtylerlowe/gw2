var shipmentItems = {
    trophies: [
        { id: 24350, dropRateLink: "https://wiki.guildwars2.com/wiki/Trophy_Shipment/Drop_rate", name: "Large Bone", multiplier: 4.99 },
        { id: 24350, dropRateLink: "https://wiki.guildwars2.com/wiki/Trophy_Shipment/Drop_rate", name: "Large Claw", multiplier: 4.91 },
        { id: 24276, dropRateLink: "https://wiki.guildwars2.com/wiki/Trophy_Shipment/Drop_rate", name: "Pile of Incandescent Dust", multiplier: 4.91 },
        { id: 24356, dropRateLink: "https://wiki.guildwars2.com/wiki/Trophy_Shipment/Drop_rate", name: "Large Fang", multiplier: 4.93 },
        { id: 24288, dropRateLink: "https://wiki.guildwars2.com/wiki/Trophy_Shipment/Drop_rate", name: "Large Scale", multiplier: 5.06 },
        { id: 24299, dropRateLink: "https://wiki.guildwars2.com/wiki/Trophy_Shipment/Drop_rate", name: "Intricate Totem", multiplier: 5.03 },
        { id: 24282, dropRateLink: "https://wiki.guildwars2.com/wiki/Trophy_Shipment/Drop_rate", name: "Potent Venom Sac", multiplier: 5.15 },
        { id: 24294, dropRateLink: "https://wiki.guildwars2.com/wiki/Trophy_Shipment/Drop_rate", name: "Vial of Potent Blood", multiplier: 5.18 },
        { id: 24358, dropRateLink: "https://wiki.guildwars2.com/wiki/Trophy_Shipment/Drop_rate", name: "Ancient Bone", multiplier: 0.99 },
        { id: 24351, dropRateLink: "https://wiki.guildwars2.com/wiki/Trophy_Shipment/Drop_rate", name: "Vicious Claw", multiplier: 1.00 },
        { id: 24277, dropRateLink: "https://wiki.guildwars2.com/wiki/Trophy_Shipment/Drop_rate", name: "Pile of Crystalline Dust", multiplier: 1.01 },
        { id: 24357, dropRateLink: "https://wiki.guildwars2.com/wiki/Trophy_Shipment/Drop_rate", name: "Vicious Fang", multiplier: 1.02 },
        { id: 24289, dropRateLink: "https://wiki.guildwars2.com/wiki/Trophy_Shipment/Drop_rate", name: "Armored Scale", multiplier: 1.01 },
        { id: 24300, dropRateLink: "https://wiki.guildwars2.com/wiki/Trophy_Shipment/Drop_rate", name: "Elaborate Totem", multiplier: 0.98 },
        { id: 24283, dropRateLink: "https://wiki.guildwars2.com/wiki/Trophy_Shipment/Drop_rate", name: "Powerful Venom Sac", multiplier: 0.98 },
        { id: 24295, dropRateLink: "https://wiki.guildwars2.com/wiki/Trophy_Shipment/Drop_rate", name: "Vial of Powerful Blood", multiplier: 0.98 },
        { id: 83103, dropRateLink: "https://wiki.guildwars2.com/wiki/Trophy_Shipment/Drop_rate", name: "Eye of Kormir", multiplier: 0.21 },
        { id: 83757, dropRateLink: "https://wiki.guildwars2.com/wiki/Trophy_Shipment/Drop_rate", name: "Congealed Putrescence", multiplier: 0.20 }
    ],
    cloth: [
        { id: 19718, dropRateLink: "https://wiki.guildwars2.com/wiki/Cloth_Shipment/Drop_rate", name: "Jute Scrap", multiplier: 8.22 },
        { id: 19739, dropRateLink: "https://wiki.guildwars2.com/wiki/Cloth_Shipment/Drop_rate", name: "Wool Scrap", multiplier: 8.17 },
        { id: 19741, dropRateLink: "https://wiki.guildwars2.com/wiki/Cloth_Shipment/Drop_rate", name: "Cotton Scrap", multiplier: 7.49 },
        { id: 19743, dropRateLink: "https://wiki.guildwars2.com/wiki/Cloth_Shipment/Drop_rate", name: "Linen Scrap", multiplier: 8.44 },
        { id: 19748, dropRateLink: "https://wiki.guildwars2.com/wiki/Cloth_Shipment/Drop_rate", name: "Silk Scrap", multiplier: 59.34 },
        { id: 19745, dropRateLink: "https://wiki.guildwars2.com/wiki/Cloth_Shipment/Drop_rate", name: "Gossamer Scrap", multiplier: 7.94 }
    ],
    leather: [
        { id: 19719, dropRateLink: "https://wiki.guildwars2.com/wiki/Leather_Shipment/Drop_rate", name: "Rawhide Leather Section", multiplier: 7.69 },
        { id: 19728, dropRateLink: "https://wiki.guildwars2.com/wiki/Leather_Shipment/Drop_rate", name: "Thin Leather Section", multiplier: 7.71 },
        { id: 19730, dropRateLink: "https://wiki.guildwars2.com/wiki/Leather_Shipment/Drop_rate", name: "Coarse Leather Section", multiplier: 8.36 },
        { id: 19731, dropRateLink: "https://wiki.guildwars2.com/wiki/Leather_Shipment/Drop_rate", name: "Rugged Leather Section", multiplier: 8.29 },
        { id: 19729, dropRateLink: "https://wiki.guildwars2.com/wiki/Leather_Shipment/Drop_rate", name: "Thick Leather Section", multiplier: 59.81 },
        { id: 19732, dropRateLink: "https://wiki.guildwars2.com/wiki/Leather_Shipment/Drop_rate", name: "Hardened Leather Section", multiplier: 7.97 }
    ],
    metal: [
        { id: 19697, dropRateLink: "https://wiki.guildwars2.com/wiki/Metal_Shipment/Drop_rate", name: "Copper Ore", multiplier: 8.01 },
        { id: 19699, dropRateLink: "https://wiki.guildwars2.com/wiki/Metal_Shipment/Drop_rate", name: "Iron Ore", multiplier: 16.50 },
        { id: 19702, dropRateLink: "https://wiki.guildwars2.com/wiki/Metal_Shipment/Drop_rate", name: "Platinum Ore", multiplier: 8.33 },
        { id: 19700, dropRateLink: "https://wiki.guildwars2.com/wiki/Metal_Shipment/Drop_rate", name: "Mithril Ore", multiplier: 58.96 },
        { id: 19701, dropRateLink: "https://wiki.guildwars2.com/wiki/Metal_Shipment/Drop_rate", name: "Orichalcum Ore", multiplier: 8.20 }
    ],
    wood: [
        { id: 19723, dropRateLink: "https://wiki.guildwars2.com/wiki/Wood_Shipment/Drop_rate", name: "Green Wood Log", multiplier: 7.72 },
        { id: 19726, dropRateLink: "https://wiki.guildwars2.com/wiki/Wood_Shipment/Drop_rate", name: "Soft Wood Log", multiplier: 7.94 },
        { id: 19727, dropRateLink: "https://wiki.guildwars2.com/wiki/Wood_Shipment/Drop_rate", name: "Seasoned Wood Log", multiplier: 8.07 },
        { id: 19724, dropRateLink: "https://wiki.guildwars2.com/wiki/Wood_Shipment/Drop_rate", name: "Hard Wood Log", multiplier: 7.88 },
        { id: 19722, dropRateLink: "https://wiki.guildwars2.com/wiki/Wood_Shipment/Drop_rate", name: "Elder Wood Log", multiplier: 59.90 },
        { id: 19725, dropRateLink: "https://wiki.guildwars2.com/wiki/Wood_Shipment/Drop_rate", name: "Ancient Wood Log", multiplier: 8.33 }
    ]
};

var ids = '24350,24276,24356,24288,24299,24282,24294,24358,24351,24277,24357,24289,24300,24283,24295,83103,83757,19718,19739,19741,19743,19748,19745,19719,19728,19730,19731,19729,19732,19697,19699,19702,19700,19701,19723,19726,19727,19724,19722,19725';
var buySellValue = 'sell';
var considerTPAndGoldCost = 'disclude';
var maxColumnCount = 18;
var expandedDisplay = false;
var prices = gw2ApiCall("v2/commerce/prices", [{ ids: ids }]);

$(document).ready(function () {

    Object.keys(shipmentItems).forEach(function (key, index) {
        shipmentItems[key] = mergeDataByKey(shipmentItems[key], prices, 'id');
        shipmentItems[key] = addAdjustedValue(shipmentItems[key]);
        shipmentItems[key].push(getAdjustedTotal(shipmentItems[key]));
    });

    displayEverything();

    $('input[name=buySellSelection]').click(function () {
        buySellValue = $('input[name=buySellSelection]:checked').val();
        $('#item-list').find("tr:gt(0)").remove();
        displayEverything();
    });
    $('input[name=adjustments]').click(function () {
        considerTPAndGoldCost = $('input[name=adjustments]:checked').val();
        $('#item-list').find("tr:gt(0)").remove();
        displayEverything();
    });
});

var addAdjustedValue = function (items) {
    for (var i = 0; i < items.length; i++) {
        items[i].adjustedSellValue = Number((items[i].sells.unit_price * items[i].multiplier).toFixed(2));
        items[i].adjustedBuyValue = Number((items[i].buys.unit_price * items[i].multiplier).toFixed(2));
    }

    return items;
};

var getAdjustedTotal = function (items) {
    var buyTotalAdjusted = 0;
    var sellTotalAdjusted = 0;
    var buyTotalTP = 0;
    var sellTotalTP = 0;

    for (var i = 0; i < items.length; i++) {
        buyTotalAdjusted += items[i].adjustedBuyValue;
        sellTotalAdjusted += items[i].adjustedSellValue;
        buyTotalTP += items[i].buys.unit_price;
        sellTotalTP += items[i].sells.unit_price;
    }

    return {
        id: 'total',
        adjustedBuyValue: buyTotalAdjusted.toFixed(2),
        adjustedSellValue: sellTotalAdjusted.toFixed(2),
        buys: { unit_price: buyTotalTP },
        sells: { unit_price: sellTotalTP }
    };
};

var toggleDisplay = function () {
    expandedDisplay = !expandedDisplay;
    $('#item-list').find("tr:gt(0)").remove();
    displayEverything();
};

var displayEverything = function () {
    var goBySellValue = buySellValue == 'sell';
    var tax = .15;
    $('#tpTax').html((tax * 100) + '%')

    if (!expandedDisplay) {
        $('.items-column').hide();
    } else {
        $('.items-column').show();
    }

    Object.keys(shipmentItems).forEach(function (key, index) {
        var generatedHtml =
            '<tr class="item-row">' +
            '<td style="text-transform:capitalize; border-right:2px solid #333;">' + key + '</td>'; //"Type"

        var columnCorrectionCount = maxColumnCount;

        shipmentItems[key].forEach(function (item) {
            var tpValue = goBySellValue ? item.sells.unit_price : item.buys.unit_price;
            var adjustedValue = goBySellValue ? item.adjustedSellValue : item.adjustedBuyValue;
            var taxAdjustedValue = (adjustedValue - (adjustedValue * tax)) - 10000;

            if (item.id == 'total') {
                if (expandedDisplay) {
                    for (var i = 0; i < columnCorrectionCount; i++) {
                        generatedHtml += '<td></td>';
                    }
                }

                generatedHtml +=
                    '<td style="font-weight:bold;  border-left:2px solid #333;">' +
                    convertValueToGoldHtmlString({ unit_price: Number(adjustedValue) }, expandedDisplay ? 2 : undefined) +
                    '</td>';
                generatedHtml +=
                    '<td style="font-weight:bold;  border-left:2px solid #333;" ' + (taxAdjustedValue < 0 ? 'class="negative-currency"' : '') + '>' +
                    convertValueToGoldHtmlString({ unit_price: Number(taxAdjustedValue) }, expandedDisplay ? 2 : undefined) +
                    '</td>';
            } else if (expandedDisplay) {
                columnCorrectionCount--;

                generatedHtml +=
                    '<td class="shipment-item-cell">' +
                        '<div class="shipment-item-name">' + item.name + '</div>' +
                        '<div class="shipment-item-multiplier"><a target="_blank" href="' + item.dropRateLink + '">' + item.multiplier + '</a></div>' +
                        '<div class="shipment-item-value">' + convertValueToGoldHtmlString({ unit_price: Number(tpValue) }) + '</div>' +
                    '</td>';
            }

        });
        generatedHtml += '</tr>';

        $('#item-list tr:last').after(generatedHtml);
    });
    $('.full-page-loading-spinner-container').hide();
    $('#item-list').show();
};
